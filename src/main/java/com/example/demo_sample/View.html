<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Task Manager FE</title>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, sans-serif;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 900px;
            padding: 20px;
        }
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            margin-bottom: 20px;
        }
        h1, h2, h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        input, button {
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        input:focus {
            outline: none;
            border-color: #2575fc;
            box-shadow: 0 0 4px rgba(37,117,252,0.5);
        }
        button {
            background: #2575fc;
            color: white;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: 0.3s;
        }
        button:hover {
            background: #FF9966;
        }
        .secondary-btn {
            background: #777;
        }
        .secondary-btn:hover {
            background: #555;
        }
        .task-list, .user-list {
            margin-top: 20px;
        }
        .task, .user {
            background: #f9f9f9;
            border-left: 4px solid #2575fc;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 6px;
        }
        .task-actions, .user-actions {
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .tab-btns {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .tab-btns button {
            background: #777;
            color: white;
            font-weight: bold;
        }
        .tab-btns button.active {
            background: #2575fc;
        }
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .pagination button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: #2575fc;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        .pagination button.disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .pagination button.active {
            background: #FF9966;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 style="text-align:center; color:white; margin-bottom:20px;">Task Manager</h1>

    <!-- ===== Auth Screen ===== -->
    <div id="authScreen" class="card">
        <h2>ƒêƒÉng k√Ω</h2>
        <form id="registerForm">
            <input type="email" id="registerEmail" placeholder="Email" required>
            <input type="password" id="registerPassword" placeholder="M·∫≠t kh·∫©u" required>
            <button type="submit">ƒêƒÉng k√Ω</button>
        </form>

        <h2 style="margin-top:20px;">ƒêƒÉng nh·∫≠p</h2>
        <form id="loginForm">
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u" required>
            <button type="submit">ƒêƒÉng nh·∫≠p</button>
        </form>
    </div>

    <!-- ===== Main Screen ===== -->
    <div id="mainScreen" class="hidden">
        <div class="header">
            <div class="tab-btns">
                <button id="taskTabBtn" class="active">Qu·∫£n l√Ω Task</button>
                <button id="userTabBtn" class="hidden">Qu·∫£n l√Ω User</button>
            </div>
            <button id="logoutBtn" class="secondary-btn">ƒêƒÉng xu·∫•t</button>
        </div>

        <!-- Task Management Tab -->
        <div id="taskTab">
            <div class="card">
                <form id="taskForm">
                    <h3 id="taskFormTitle">T·∫°o Task</h3>
                    <input type="hidden" id="taskId">
                    <input type="text" id="requirementName" placeholder="Requirement Name" required>
                    <input type="text" id="assignee" placeholder="Assignee" required>
                    <input type="text" id="reviewer" placeholder="Reviewer" required>
                    <input type="number" id="taskTypeId" placeholder="TaskTypeId (1-4)" required>
                    <input type="date" id="date" required>
                    <input type="number" step="0.5" id="planFrom" placeholder="Plan From" required>
                    <input type="number" step="0.5" id="planTo" placeholder="Plan To" required>
                    <button type="submit">L∆∞u Task</button>
                    <button type="button" id="cancelEditBtn" class="secondary-btn hidden">H·ªßy</button>
                </form>
            </div>

            <!-- üîé Search Task -->
            <div class="card">
                <h3>T√¨m ki·∫øm Task</h3>
                <form id="searchForm">
                    <input type="text" id="searchKeyword" placeholder="Nh·∫≠p Task ID ho·∫∑c Requirement Name">
                    <button type="submit">T√¨m ki·∫øm</button>
                </form>
                <div id="searchResult" style="margin-top:15px;"></div>
            </div>

            <div class="card">
                <h3>Danh s√°ch Task</h3>
                <div class="task-list" id="taskList"></div>
                <div class="pagination" id="pagination"></div>
            </div>

            <!-- NEW: Count All Tasks -->
            <div class="card">
                <h3>Th·ªëng k√™ Task theo Type</h3>
                <button id="countAllBtn">Count All Status</button>
                <div id="countAllResult" style="margin-top: 15px; white-space: pre-line;"></div>
            </div>
        </div>

        <!-- User Management Tab -->
        <div id="userTab" class="hidden">
            <div class="card">
                <h3>Danh s√°ch User</h3>
                <div class="user-list" id="userList"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";
    let accessToken = null;
    let currentPage = 0;
    let totalPages = 1;
    let isAdmin = false;

    const authScreen = document.getElementById("authScreen");
    const mainScreen = document.getElementById("mainScreen");
    const taskTabBtn = document.getElementById("taskTabBtn");
    const userTabBtn = document.getElementById("userTabBtn");
    const taskTab = document.getElementById("taskTab");
    const userTab = document.getElementById("userTab");

    // ===== REGISTER =====
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = registerEmail.value;
        const password = registerPassword.value;
        const res = await fetch(`${API_BASE}/account/register`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ email, password })
        });
        if (res.ok) alert("ƒêƒÉng k√Ω th√†nh c√¥ng!");
        else alert("ƒêƒÉng k√Ω th·∫•t b·∫°i!");
    });

    // ===== LOGIN =====
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = loginEmail.value;
        const password = loginPassword.value;
        const res = await fetch(`${API_BASE}/account/login`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (res.ok) {
            accessToken = data.accessToken;
            isAdmin = data.email.toLowerCase() === "admin@gmail.com";

            authScreen.classList.add("hidden");
            mainScreen.classList.remove("hidden");

            if (isAdmin) {
                userTabBtn.classList.remove("hidden");
            } else {
                userTabBtn.classList.add("hidden");
                userTab.classList.add("hidden");
            }

            loadTasks();
        } else {
            alert(data.error || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i");
        }
    });

    // ===== LOGOUT =====
    document.getElementById("logoutBtn").addEventListener("click", async () => {
        await fetch(`${API_BASE}/account/logout`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${accessToken}` }
        });
        accessToken = null;
        taskList.innerHTML = "";
        userList.innerHTML = "";
        mainScreen.classList.add("hidden");
        authScreen.classList.remove("hidden");
        userTabBtn.classList.add("hidden");
        userTab.classList.add("hidden");
        alert("ƒêƒÉng xu·∫•t th√†nh c√¥ng");
    });

    // ===== Helper: render 1 task =====
    function renderTaskUI(t, container) {
        container.innerHTML = `
        <div class="task">
            <b>ID:</b> ${t.taskId}<br>
            <b>Requirement:</b> ${t.requirementName}<br>
            <b>Assignee:</b> ${t.assignee}<br>
            <b>Reviewer:</b> ${t.reviewer}<br>
            <b>TaskTypeId:</b> ${t.taskTypeId}<br>
            <b>Date:</b> ${t.date}<br>
            <b>Plan:</b> ${t.planFrom} - ${t.planTo}<br>
            <div class="task-actions">
                <button onclick="editTask(${t.taskId})">‚úèÔ∏è S·ª≠a</button>
                <button onclick="deleteTask(${t.taskId})">üóëÔ∏è X√≥a</button>
            </div>
        </div>`;
    }

    // ===== Task CRUD =====
    document.getElementById("taskForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = taskId.value;
        const body = {
            requirementName: requirementName.value,
            assignee: assignee.value,
            reviewer: reviewer.value,
            taskTypeId: parseInt(taskTypeId.value),
            date: date.value,
            planFrom: parseFloat(planFrom.value),
            planTo: parseFloat(planTo.value)
        };
        let url = `${API_BASE}/tasks`, method = "POST";
        if (id) { url = `${API_BASE}/tasks/${id}`; method = "PUT"; }
        const res = await fetch(url, {
            method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${accessToken}`
            },
            body: JSON.stringify(body)
        });
        const data = await res.json();
        if (res.ok) {
            alert(data.message);
            resetTaskForm();
            loadTasks(currentPage);
            document.getElementById("searchForm").dispatchEvent(new Event("submit"));
        } else alert(JSON.stringify(data));
    });

    document.getElementById("cancelEditBtn").addEventListener("click", resetTaskForm);

    async function loadTasks(page = 0) {
        const res = await fetch(`${API_BASE}/tasks?page=${page}&size=2`, {
            headers: { "Authorization": `Bearer ${accessToken}` }
        });
        const data = await res.json();
        const tasks = data.content || [];
        currentPage = data.number;
        totalPages = data.totalPages;

        taskList.innerHTML = tasks.map(t => `
        <div class="task">
            <b>ID:</b> ${t.taskId}<br>
            <b>Requirement:</b> ${t.requirementName}<br>
            <b>Assignee:</b> ${t.assignee}<br>
            <b>Reviewer:</b> ${t.reviewer}<br>
            <b>TaskTypeId:</b> ${t.taskTypeId}<br>
            <b>Date:</b> ${t.date}<br>
            <b>Plan:</b> ${t.planFrom} - ${t.planTo}<br>
            <div class="task-actions">
                <button onclick="editTask(${t.taskId})">‚úèÔ∏è S·ª≠a</button>
                <button onclick="deleteTask(${t.taskId})">üóëÔ∏è X√≥a</button>
            </div>
        </div>`).join("");
        renderPagination();
    }

    function renderPagination() {
        const pagination = document.getElementById("pagination");
        let buttons = `<button onclick="changePage(${currentPage-1})" class="${currentPage===0?'disabled':''}">¬´</button>`;
        for(let i=0;i<totalPages;i++){
            buttons += `<button onclick="changePage(${i})" class="${i===currentPage?'active':''}">${i+1}</button>`;
        }
        buttons += `<button onclick="changePage(${currentPage+1})" class="${currentPage===totalPages-1?'disabled':''}">¬ª</button>`;
        pagination.innerHTML = buttons;
    }

    function changePage(page){ if(page<0||page>=totalPages)return; loadTasks(page); }

    async function editTask(id){
        const res = await fetch(`${API_BASE}/tasks/${id}`, { headers:{ "Authorization": `Bearer ${accessToken}` } });
        const t = await res.json();
        taskId.value = t.taskId;
        requirementName.value = t.requirementName;
        assignee.value = t.assignee;
        reviewer.value = t.reviewer;
        taskTypeId.value = t.taskTypeId;
        date.value = t.date;
        planFrom.value = t.planFrom;
        planTo.value = t.planTo;
        document.getElementById("taskFormTitle").innerText="C·∫≠p nh·∫≠t Task";
        cancelEditBtn.classList.remove("hidden");
    }

    async function deleteTask(id){
        if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a task n√†y?")) return;
        const res = await fetch(`${API_BASE}/tasks/${id}`, {
            method:"DELETE",
            headers:{ "Authorization": `Bearer ${accessToken}` }
        });
        if(res.ok){
            alert("X√≥a task th√†nh c√¥ng");
            loadTasks(currentPage);
            document.getElementById("searchForm").dispatchEvent(new Event("submit"));
        } else{ const data = await res.json(); alert(data.error || "X√≥a th·∫•t b·∫°i");}
    }

    function resetTaskForm(){
        taskForm.reset();
        taskId.value = "";
        document.getElementById("taskFormTitle").innerText="T·∫°o Task";
        cancelEditBtn.classList.add("hidden");
    }

    // ===== SEARCH TASK =====
    document.getElementById("searchForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const keyword = searchKeyword.value.trim();
        if (!keyword) return;
        let url = "";
        if (!isNaN(keyword)) {
            url = `${API_BASE}/tasks/search?id=${keyword}`;
        } else {
            url = `${API_BASE}/tasks/search?requirementName=${encodeURIComponent(keyword)}`;
        }
        const res = await fetch(url, {
            headers:{ "Authorization": `Bearer ${accessToken}` }
        });
        const container = document.getElementById("searchResult");
        if(res.ok){
            const data = await res.json();
            const tasks = data.content || (Array.isArray(data) ? data : [data]);
            if(tasks.length > 0){
                container.innerHTML = tasks.map(t => `
                    <div class="task">
                        <b>ID:</b> ${t.taskId}<br>
                        <b>Requirement:</b> ${t.requirementName}<br>
                        <b>Assignee:</b> ${t.assignee}<br>
                        <b>Reviewer:</b> ${t.reviewer}<br>
                        <b>TaskTypeId:</b> ${t.taskTypeId}<br>
                        <b>Date:</b> ${t.date}<br>
                        <div class="task-actions">
                            <button onclick="editTask(${t.taskId})">‚úèÔ∏è S·ª≠a</button>
                            <button onclick="deleteTask(${t.taskId})">üóëÔ∏è X√≥a</button>
                        </div>
                    </div>
                `).join("");
            } else {
                container.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y Task n√†o</p>";
            }
        } else {
            container.innerHTML = `<p style="color:red;">‚ùå Kh√¥ng t√¨m th·∫•y task</p>`;
        }
    });

    // ===== Count All Tasks =====
    document.getElementById("countAllBtn").addEventListener("click", async () => {
        const res = await fetch(`${API_BASE}/tasks/count-all`, {
            headers: { "Authorization": `Bearer ${accessToken}` }
        });
        const data = await res.json();
        const resultDiv = document.getElementById("countAllResult");

        if (res.ok) {
            const message = data.message;
            let text = "üìä Count All Status:\n";
            if (Array.isArray(message)) {
                text += message.join("\n");
            } else {
                for (const [typeId, count] of Object.entries(message)) {
                    text += `TaskTypeId ${typeId}: ${count}\n`;
                }
            }
            resultDiv.textContent = text;
        } else {
            resultDiv.textContent = data.error || "‚ùå L·ªói khi l·∫•y th·ªëng k√™";
        }
    });

    // ===== USERS (Admin only) =====
    async function loadUsers(){
        try {
            const res = await fetch(`${API_BASE}/account`, { headers:{ "Authorization": `Bearer ${accessToken}` } });
            if(!res.ok) throw new Error("L·∫•y danh s√°ch user th·∫•t b·∫°i");
            const users = await res.json();
            userList.innerHTML = users.map(u => `
                <div class="user">
                    <b>ID:</b> ${u.id} <br>
                    <b>Email:</b> ${u.email} <br>
                    <div class="user-actions">
                        <button onclick="deleteUser(${u.id})">üóëÔ∏è X√≥a</button>
                    </div>
                </div>
            `).join("");
        } catch(err) {
            userList.innerHTML = `<p style="color:red;">${err.message}</p>`;
        }
    }

    async function deleteUser(id){
        if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a user n√†y?")) return;
        try {
            const res = await fetch(`${API_BASE}/account/${id}`,{
                method:"DELETE",
                headers:{ "Authorization": `Bearer ${accessToken}` }
            });
            if(!res.ok) throw new Error("X√≥a th·∫•t b·∫°i");
            alert("X√≥a user th√†nh c√¥ng");
            await loadUsers();
        } catch(err) {
            alert(err.message);
        }
    }

    // ===== Tabs =====
    taskTabBtn.addEventListener("click", ()=>{
        taskTabBtn.classList.add("active");
        userTabBtn.classList.remove("active");
        taskTab.classList.remove("hidden");
        userTab.classList.add("hidden");
    });

    userTabBtn.addEventListener("click", async ()=>{
        taskTabBtn.classList.remove("active");
        userTabBtn.classList.add("active");
        taskTab.classList.add("hidden");
        userTab.classList.remove("hidden");

        if(!isAdmin) return;
        await loadUsers();
    });
</script>

</body>
</html>